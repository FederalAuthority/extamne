local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local char = player.Character
local humanoid = char:WaitForChild("Humanoid")

local Window = Rayfield:CreateWindow({
    Name = "Nya Hub",
    Icon = 0,
    LoadingTitle = "Nya Hub",
    LoadingSubtitle = "by Nya",
    ShowText = "Rayfield",
    Theme = "DarkBlue",
    ToggleUIKeybind = "K",
    DisableRayfieldPrompts = false,
    DisableBuildWarnings = false,
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Nya Examination",
        FileName = "Hub"
    },
})

-- Main Tab
local MainTab = Window:CreateTab("Main", "home")
MainTab:CreateSection("Change log")
MainTab:CreateParagraph({Title = "NOVEMBER 24", Content = "Added Box ESP · Added Skeleton ESP · Reorganized ESP UI"})

-- Hunter Mode
local HunterModeEnabled = false
local HunterModeToggle = MainTab:CreateToggle({
    Name = "Hunter mode",
    CurrentValue = false,
    Flag = "HunterModeToggle",
    Callback = function(v)
        HunterModeEnabled = v
        local char = player.Character or player.CharacterAdded:Wait()
        local isHunter = char:FindFirstChild("IsHunter")
        if isHunter then
            isHunter.Value = v
        end
    end,
})

player.CharacterAdded:Connect(function(char)
    task.wait(0.3)
    local isHunter = char:WaitForChild("IsHunter", 2)
    if isHunter then
        isHunter.Value = HunterModeEnabled
    end
end)

-- Health Section
MainTab:CreateSection("Health")
MainTab:CreateButton({
    Name = "Reset",
    Callback = function()
        if char and humanoid then
            humanoid.Health = 0
        end
    end,
})

MainTab:CreateKeybind({
    Name = "Reset (keybind)",
    CurrentKeybind = "V",
    HoldToInteract = false,
    Flag = "ResetKeybind",
    Callback = function()
        if char and humanoid then
            humanoid.Health = 0
        end
    end,
})

-- Camera Section
local cameraToggleState = false
local function ApplyCameraSettings()
    if not player then return end
    if cameraToggleState == true then
        pcall(function()
            player.CameraMode = Enum.CameraMode.Classic
            player.CameraMaxZoomDistance = 15
        end)
    else
        pcall(function()
            player.CameraMode = Enum.CameraMode.LockFirstPerson
        end)
    end
end

player.CharacterAdded:Connect(function(char)
    if char then
        local humanoid = char:WaitForChild("Humanoid", 2)
        task.wait(0.25)
        ApplyCameraSettings()
    end
end)

local ThirdPersonToggle = MainTab:CreateToggle({
    Name = "Third person",
    CurrentValue = false,
    Flag = "ThirdPersonToggle",
    Callback = function(v)
        cameraToggleState = v
        ApplyCameraSettings()
    end,
})

-- Chat Section
local chatEnabled = false
local function ApplyChatState()
    local chatConfig = ChatService:FindFirstChild("ChatWindowConfiguration")
    if chatConfig then
        pcall(function()
            chatConfig.Enabled = chatEnabled
        end)
    end
end

player.CharacterAdded:Connect(function()
    task.wait(0.5)
    ApplyChatState()
end)

local ChatToggle = MainTab:CreateToggle({
    Name = "Chat history",
    CurrentValue = false,
    Flag = "ChatToggle",
    Callback = function(v)
        chatEnabled = v
        ApplyChatState()
    end,
})

-- Map Section
MainTab:CreateSection("Map")
MainTab:CreateButton({
    Name = "Remove Elephant Foot",
    Callback = function()
        local foot = game.workspace:FindFirstChild("LookAtMe")
        if foot then foot:Destroy() end
    end,
})

MainTab:CreateButton({
    Name = "Remove console teleport",
    Callback = function()
        local teleport = game.workspace:FindFirstChild("ConsoleTeleport")
        if teleport then teleport:Destroy() end
    end,
})

MainTab:CreateButton({
    Name = "Remove radiation",
    Callback = function()
        local radiation = game.workspace:FindFirstChild("Radiation")
        if radiation then radiation:Destroy() end
    end,
})

-- Movement Tab
local MovementTab = Window:CreateTab("Movement", "move")

-- WalkSpeed
local walkSpeed = 7
local lockSpeed = false

local function applySpeed()
    if humanoid and humanoid.Parent and humanoid.Parent:FindFirstChild("IsHunter") then
        humanoid.WalkSpeed = walkSpeed
    end
end

player.CharacterAdded:Connect(function(newChar)
    char = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    task.wait(0.3)
    if lockSpeed then applySpeed() end
end)

RunService.Heartbeat:Connect(function()
    if humanoid and lockSpeed and humanoid.WalkSpeed ~= walkSpeed then
        humanoid.WalkSpeed = walkSpeed
    end
end)

MovementTab:CreateSection("WalkSpeed")
local WalkSpeedToggle = MovementTab:CreateToggle({
    Name = "WalkSpeed Override",
    CurrentValue = lockSpeed,
    Flag = "WalkSpeedToggle",
    Callback = function(v)
        lockSpeed = v
        if v then applySpeed() end
    end,
})

local WalkSpeedSlider = MovementTab:CreateSlider({
    Name = "WalkSpeed",
    Range = {0, 100},
    Increment = 1,
    Suffix = "speed",
    CurrentValue = walkSpeed,
    Flag = "WalkSpeedSlider",
    Callback = function(v)
        walkSpeed = v
        if lockSpeed then applySpeed() end
    end,
})

-- JumpHeight
local jumpHeight = 2
local lockJump = false

local function applyJump()
    if humanoid and humanoid.Parent then
        humanoid.UseJumpPower = false
        humanoid.JumpHeight = jumpHeight
    end
end

player.CharacterAdded:Connect(function(newChar)
    char = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    task.wait(0.3)
    if lockJump then applyJump() end
end)

RunService.Heartbeat:Connect(function()
    if humanoid and lockJump and humanoid.JumpHeight ~= jumpHeight then
        humanoid.JumpHeight = jumpHeight
    end
end)

MovementTab:CreateSection("JumpHeight")
local JumpHeightToggle = MovementTab:CreateToggle({
    Name = "JumpHeight override",
    CurrentValue = lockJump,
    Flag = "JumpHeightToggle",
    Callback = function(v)
        lockJump = v
        if v then applyJump() end
    end,
})

local JumpHeightSlider = MovementTab:CreateSlider({
    Name = "JumpHeight",
    Range = {0, 150},
    Increment = 1,
    Suffix = "studs",
    CurrentValue = jumpHeight,
    Flag = "JumpHeightSlider",
    Callback = function(v)
        jumpHeight = v
        if lockJump then applyJump() end
    end,
})

-- Lighting Tab
local LightingTab = Window:CreateTab("Lighting", "lightbulb")
local fogFarEnabled = 45
local fogFarDisabled = 500
local fogEnabled = true
local fullbrightColor = Color3.fromRGB(255, 255, 255)
local defaultColor = Color3.fromRGB(0, 0, 0)
local fullbrightEnabled = false
local ambientColor = Color3.fromRGB(0, 0, 0)

local FogToggle = LightingTab:CreateToggle({
    Name = "Fog",
    CurrentValue = true,
    Flag = "FogToggle",
    Callback = function(v)
        fogEnabled = v
        Lighting.FogEnd = v and fogFarEnabled or fogFarDisabled
    end,
})

Lighting:GetPropertyChangedSignal("FogEnd"):Connect(function()
    if fogEnabled and Lighting.FogEnd ~= fogFarEnabled then
        Lighting.FogEnd = fogFarEnabled
    elseif not fogEnabled and Lighting.FogEnd ~= fogFarDisabled then
        Lighting.FogEnd = fogFarDisabled
    end
end)

local FullbrightToggle = LightingTab:CreateToggle({
    Name = "Fullbright",
    CurrentValue = false,
    Flag = "FullbrightToggle",
    Callback = function(v)
        fullbrightEnabled = v
        Lighting.Ambient = v and fullbrightColor or defaultColor
    end,
})

Lighting:GetPropertyChangedSignal("Ambient"):Connect(function()
    if fullbrightEnabled and Lighting.Ambient ~= fullbrightColor then
        Lighting.Ambient = fullbrightColor
    elseif not fullbrightEnabled and Lighting.Ambient ~= defaultColor then
        Lighting.Ambient = defaultColor
    end
end)

local ColorPicker = LightingTab:CreateColorPicker({
    Name = "Ambient color",
    Color = ambientColor,
    Flag = "AmbientColorPicker",
    Callback = function(v)
        ambientColor = v
        Lighting.Ambient = v
    end
})

-- GUI Tab
local GuiTab = Window:CreateTab("GUI", "panel-left")

-- ESP System
local ESPFolder = workspace:WaitForChild("Characters")
local HighlightESPEnabled = false
local BoxESPEnabled = false
local SkeletonESPEnabled = false

local highlights = {}
local boxESPs = {}
local skeletonESPs = {}

-- Highlight ESP
local function createHighlight(character)
    if not character or highlights[character] then return end
    
    local highlight = Instance.new("Highlight")
    highlight.Parent = character
    highlight.Adornee = character
    
    if character:FindFirstChild("Humanoid") then
        if game.Players:GetPlayerFromCharacter(character) then
            highlight.FillColor = Color3.fromRGB(80, 109, 84) -- Green for players
        else
            highlight.FillColor = Color3.fromRGB(255, 0, 0) -- Red for NPCs
        end
        highlight.FillTransparency = 0.25
        highlight.OutlineTransparency = 0
    end
    
    highlight.Enabled = HighlightESPEnabled
    highlights[character] = highlight
end

local function setHighlightESPEnabled(state)
    HighlightESPEnabled = state
    for _, highlight in pairs(highlights) do
        if highlight then
            highlight.Enabled = state
        end
    end
end

-- Box ESP (Fixed Centering)
local function createBoxESP(character)
    if not character or boxESPs[character] then return end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    -- Calculate proper box size based on character height
    local boxSize = Vector3.new(4, humanoid.HipHeight * 2, 4)
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "BoxESP"
    billboardGui.Adornee = hrp
    billboardGui.Size = UDim2.new(boxSize.X, 0, boxSize.Y, 0)
    billboardGui.StudsOffset = Vector3.new(0, boxSize.Y/2, 0) -- Center the box
    billboardGui.AlwaysOnTop = true
    billboardGui.Enabled = BoxESPEnabled
    billboardGui.Parent = hrp
    
    local frame = Instance.new("Frame")
    frame.Parent = billboardGui
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundTransparency = 1
    
    local color = game.Players:GetPlayerFromCharacter(character) and Color3.fromRGB(80, 109, 84) or Color3.fromRGB(255, 0, 0)
    
    -- Create box outline
    local thickness = 2
    local top = Instance.new("Frame")
    top.Name = "Top"
    top.Parent = frame
    top.Size = UDim2.new(1, 0, 0, thickness)
    top.Position = UDim2.new(0, 0, 0, 0)
    top.BackgroundColor3 = color
    top.BorderSizePixel = 0
    
    local bottom = Instance.new("Frame")
    bottom.Name = "Bottom"
    bottom.Parent = frame
    bottom.Size = UDim2.new(1, 0, 0, thickness)
    bottom.Position = UDim2.new(0, 0, 1, -thickness)
    bottom.BackgroundColor3 = color
    bottom.BorderSizePixel = 0
    
    local left = Instance.new("Frame")
    left.Name = "Left"
    left.Parent = frame
    left.Size = UDim2.new(0, thickness, 1, 0)
    left.Position = UDim2.new(0, 0, 0, 0)
    left.BackgroundColor3 = color
    left.BorderSizePixel = 0
    
    local right = Instance.new("Frame")
    right.Name = "Right"
    right.Parent = frame
    right.Size = UDim2.new(0, thickness, 1, 0)
    right.Position = UDim2.new(1, -thickness, 0, 0)
    right.BackgroundColor3 = color
    right.BorderSizePixel = 0
    
    boxESPs[character] = billboardGui
end

local function setBoxESPEnabled(state)
    BoxESPEnabled = state
    for _, box in pairs(boxESPs) do
        if box then
            box.Enabled = state
        end
    end
end

-- Skeleton ESP (Fixed)
local function createSkeletonESP(character)
    if not character or skeletonESPs[character] then return end
    
    local skeletonFolder = Instance.new("Folder")
    skeletonFolder.Name = "SkeletonESP"
    skeletonFolder.Parent = character
    
    local color = game.Players:GetPlayerFromCharacter(character) and Color3.fromRGB(80, 109, 84) or Color3.fromRGB(255, 0, 0)
    
    local limbPairs = {
        {"Head", "UpperTorso"},
        {"UpperTorso", "LowerTorso"},
        {"UpperTorso", "LeftUpperArm"},
        {"LeftUpperArm", "LeftLowerArm"},
        {"LeftLowerArm", "LeftHand"},
        {"UpperTorso", "RightUpperArm"},
        {"RightUpperArm", "RightLowerArm"},
        {"RightLowerArm", "RightHand"},
        {"LowerTorso", "LeftUpperLeg"},
        {"LeftUpperLeg", "LeftLowerLeg"},
        {"LeftLowerLeg", "LeftFoot"},
        {"LowerTorso", "RightUpperLeg"},
        {"RightUpperLeg", "RightLowerLeg"},
        {"RightLowerLeg", "RightFoot"}
    }
    
    local function createLine(part1Name, part2Name)
        local part1 = character:FindFirstChild(part1Name)
        local part2 = character:FindFirstChild(part2Name)
        
        if not part1 or not part2 then return end
        
        local attachment0 = Instance.new("Attachment")
        attachment0.Parent = part1
        attachment0.Position = Vector3.new(0, 0, 0)
        
        local attachment1 = Instance.new("Attachment")
        attachment1.Parent = part2
        attachment1.Position = Vector3.new(0, 0, 0)
        
        local beam = Instance.new("Beam")
        beam.Parent = skeletonFolder
        beam.Attachment0 = attachment0
        beam.Attachment1 = attachment1
        beam.Color = ColorSequence.new(color)
        beam.FaceCamera = true
        beam.Width0 = 0.1
        beam.Width1 = 0.1
        beam.Enabled = SkeletonESPEnabled
        
        return beam
    end
    
    for _, pair in ipairs(limbPairs) do
        createLine(pair[1], pair[2])
    end
    
    skeletonESPs[character] = skeletonFolder
end

local function setSkeletonESPEnabled(state)
    SkeletonESPEnabled = state
    for _, folder in pairs(skeletonESPs) do
        if folder then
            for _, beam in pairs(folder:GetChildren()) do
                if beam:IsA("Beam") then
                    beam.Enabled = state
                end
            end
        end
    end
end

-- Initialize ESP for character
local function initializeESPForCharacter(character)
    task.wait(0.1)
    createHighlight(character)
    createBoxESP(character)
    createSkeletonESP(character)
end

-- ESP Toggles
GuiTab:CreateSection("ESP")
local HighlightESPToggle = GuiTab:CreateToggle({
    Name = "Highlight ESP",
    CurrentValue = false,
    Flag = "HighlightESPToggle",
    Callback = function(value)
        setHighlightESPEnabled(value)
    end
})

local BoxESPToggle = GuiTab:CreateToggle({
    Name = "Box ESP",
    CurrentValue = false,
    Flag = "BoxESPToggle",
    Callback = function(value)
        setBoxESPEnabled(value)
    end
})

local SkeletonESPToggle = GuiTab:CreateToggle({
    Name = "Skeleton ESP",
    CurrentValue = false,
    Flag = "SkeletonESPToggle",
    Callback = function(value)
        setSkeletonESPEnabled(value)
    end
})

-- Connect ESP to characters
ESPFolder.ChildAdded:Connect(function(character)
    initializeESPForCharacter(character)
end)

for _, character in pairs(ESPFolder:GetChildren()) do
    initializeESPForCharacter(character)
end

-- Death UI
GuiTab:CreateSection("Death UI")
local DeathHidden = false
local function updateDeathUI()
    local deathGui = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("Death")
    if deathGui then
        deathGui.Enabled = not DeathHidden
    end
end

local DeathUIToggle = GuiTab:CreateToggle({
    Name = "Death UI",
    CurrentValue = not DeathHidden,
    Flag = "DeathUIToggle",
    Callback = function(value)
        DeathHidden = not value
        updateDeathUI()
    end,
})

-- Gasmask UI
GuiTab:CreateSection("Gasmask UI")
local GasmaskHidden = false
local function updateGasmaskUI()
    local gasmaskGui = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("Gasmask")
    if gasmaskGui then
        gasmaskGui.Enabled = not GasmaskHidden
    end
end

local GasmaskUIToggle = GuiTab:CreateToggle({
    Name = "Gasmask UI",
    CurrentValue = not GasmaskHidden,
    Flag = "GasmaskUIToggle",
    Callback = function(value)
        GasmaskHidden = not value
        updateGasmaskUI()
    end,
})

-- Teleports Tab
local TPTab = Window:CreateTab("Teleports", "fast-forward")
local teleportPoints = {
    ["Sector 1"] = {
        {"Spawn", Vector3.new(-55, -33, -1410)},
        {"Generator-1", Vector3.new(135, -30, -1225)},
        {"Backup reactor", Vector3.new(-230, -30, -1428)},
        {"Mutant crawler", Vector3.new(-155, -33, -1565)},
        {"Basement valve", Vector3.new(-225, -35, -1635)},
        {"Generator-2", Vector3.new(-140, -30, -1145)},
    },
    ["Sector 2"] = {
        {"Sector entrance", Vector3.new(-110, -10, -825)},
        {"Russman's office", Vector3.new(38, -10, -895)},
        {"Armory", Vector3.new(-45, -10, -890)},
        {"Logistics area", Vector3.new(15, -10, -1040)},
        {"Steve Remington's body", Vector3.new(-30, 0, -1058)},
    },
}

local function teleportTo(position)
    local player = game.Players.LocalPlayer
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        player.Character.HumanoidRootPart.CFrame = CFrame.new(position)
    end
end

for sectorName, points in pairs(teleportPoints) do
    TPTab:CreateSection(sectorName)
    for _, data in ipairs(points) do
        local name, pos = unpack(data)
        TPTab:CreateButton({
            Name = name,
            Callback = function()
                teleportTo(pos)
            end,
        })
    end
end

-- Settings Tab
local SettingsTab = Window:CreateTab("Settings", "settings")
SettingsTab:CreateSection("Themes")

local themes = {
    ["Default"] = "Default",
    ["Amber glow"] = "AmberGlow",
    ["Amethyst"] = "Amethyst",
    ["Bloom"] = "Bloom",
    ["Dark blue"] = "DarkBlue",
    ["Green"] = "Green",
    ["Light"] = "Light",
    ["Ocean"] = "Ocean",
    ["Serenity"] = "Serenity"
}

for displayName, themeName in pairs(themes) do
    SettingsTab:CreateButton({
        Name = displayName,
        Callback = function()
            Window.ModifyTheme(themeName)
        end
    })
end

SettingsTab:CreateSection("Rayfield UI")
SettingsTab:CreateButton({
    Name = "Destroy Rayfield",
    Callback = function()
        Rayfield:Destroy()
    end,
})

-- Character cleanup
player.CharacterAdded:Connect(function(newChar)
    char = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    
    -- Reapply settings
    task.wait(0.5)
    ApplyCameraSettings()
    ApplyChatState()
    updateDeathUI()
    updateGasmaskUI()
    if lockSpeed then applySpeed() end
    if lockJump then applyJump() end
end)
